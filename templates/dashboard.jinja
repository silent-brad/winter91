{% extends "partials/_master.jinja" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<article style="max-width: 800px; margin: 0 auto;">
	<section>
		<h1>Dashboard</h1>
		<p>Track your progress towards the Winter91 goal!</p>
	</section>
	
	{% if error_message.is_some() %}
		<div class="error" style="
			background-color: var(--error-oklch-500);
			color: var(--neutral-oklch-50);
			padding: 1rem;
			border-radius: 0.375rem;
			margin-bottom: 1rem;
		">
			{{error_message.get()}}
		</div>
	{% endif %}
	
	{% if success_message.is_some() %}
		<div class="success" style="
			background-color: var(--success-oklch-500); 
			color: var(--neutral-oklch-50);
			padding: 1rem;
			border-radius: 0.375rem;
			margin-bottom: 1rem;
		">
			{{success_message.get()}}
		</div>
	{% endif %}
	
	<!-- Progress Overview -->
	{% if current_total.is_some() %}
		<div style="margin-bottom: 2rem; text-align: center; padding: 1.5rem; background-color: var(--color-surface); border-radius: 0.375rem;">
			<h2>Your Progress</h2>
			<h3 style="font-size: 2rem; color: var(--color-primary);">{{current_total.get()}}</h3>
			<p style="margin: 0;">out of 91 miles</p>
			{% let progress_percent = (current_total.get().float / 91.0 * 100.0).min(100.0) %}
      {% importnimja "partials/_progress_bar.jinja" %}
			<small style="color: var(--color-text-muted); margin-top: 0.5rem; display: block;">
				{{progress_percent.int}}% complete
			</small>
		</div>
	{% endif %}
	
	<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;" class="dashboard-grid">
		<!-- Log Miles Form -->
		<div style="background-color: var(--color-surface); padding: 1.5rem; border-radius: 0.375rem;">
			<h3>Log Miles</h3>
			<form method="post" action="/log" hx-post="/log" hx-target="#log-response" hx-swap="innerHTML">
				<label for="miles">
					Miles
					<input
						type="number"
						id="miles"
						name="miles"
						step="0.1"
						min="0.1"
						max="50"
						placeholder="Enter miles walked/run"
						{% if miles.isSome() %}value="{{miles.get()}}"{% endif %}
						required
						autofocus
					>
					<small>Enter the number of miles you walked or ran today.</small>
				</label>
				
				<div style="display: flex; gap: 0.5rem; align-items: center; margin: 1rem 0;">
					<button type="button" onclick="decrementMiles()" class="secondary" style="width: 40px;">âˆ’</button>
					<button type="button" onclick="incrementMiles()" class="secondary" style="width: 40px;">+</button>
				</div>
				
				<button type="submit">Log Miles</button>
			</form>
			<div id="log-response"></div>
		</div>
		
		<!-- Miles Graph -->
		<div style="background-color: var(--color-surface); padding: 1.5rem; border-radius: 0.375rem;">
			<h3>Miles Progress</h3>
			<canvas id="milesChart" width="300" height="200"></canvas>
		</div>
	</div>
	
	<!-- Daily Miles List -->
	<div style="background-color: var(--color-surface); padding: 1.5rem; border-radius: 0.375rem;">
		<h3>Recent Activity</h3>
		<div id="daily-miles-list">
			<p>Loading daily miles...</p>
		</div>
	</div>
</article>
{% endblock %}

{% block extra_js %}
<script src="/static/js/chart.js"></script>
<script>

function incrementMiles() {
	const input = document.getElementById('miles');
	const currentValue = parseFloat(input.value) || 0;
	input.value = (currentValue + 0.5).toFixed(1);
}

function decrementMiles() {
	const input = document.getElementById('miles');
	const currentValue = parseFloat(input.value) || 0;
	if (currentValue > 0.1) {
		input.value = (currentValue - 0.5).toFixed(1);
	}
}

// Chart setup
const ctx = document.getElementById('milesChart').getContext('2d');

/*const data = {"dates": ["2025-11-25","2025-11-24"], "miles": [10.0,12.0], "entries": [{"date": "2025-11-25", "miles": 10.0},{"date": "2025-11-24", "miles": 2.0},{"date": "2025-11-24", "miles": 6.5},{"date": "2025-11-24", "miles": 3.5}]};

new Chart(ctx, {
  type: 'line',
  data: {
	labels: data.dates,
	datasets: [{
	  label: 'Daily Miles',
	  data: data.miles, // Will be populated with miles data
	  borderColor: 'rgb(59, 130, 246)',
	  backgroundColor: 'rgba(59, 130, 246, 0.1)',
	  //tension: 0.1,
	  fill: true
	}],
  },
  options: {
	responsive: false,
  },
});*/

const milesChart = new Chart(ctx, {
	type: 'line',
	data: {
		labels: [], // Will be populated with dates
		datasets: [{
			label: 'Daily Miles',
			data: [], // Will be populated with miles data
			borderColor: 'rgb(59, 130, 246)',
			backgroundColor: 'rgba(59, 130, 246, 0.1)',
			tension: 0.1,
			fill: true
		}]
	},
	options: {
	  responsive: false,
	  scales: {
		  y: {
			  beginAtZero: true,
			  title: {
				  display: true,
				  text: 'Miles'
			  }
		  },
		  x: {
			  title: {
				  display: true,
				  text: 'Date'
			  }
		  }
	  },
	},
});

// Load chart data and daily miles list
function loadDashboardData() {
	fetch('/api/user-miles-data')
		.then(response => response.json())
		.then(data => {
			// Update chart
			milesChart.data.labels = data.dates;
			milesChart.data.datasets[0].data = data.miles;
			milesChart.update();
			
			// Update daily miles list
			const listContainer = document.getElementById('daily-miles-list');
			if (data.entries && data.entries.length > 0) {
				let html = '<table><thead><tr><th>Date</th><th>Miles</th></tr></thead><tbody>';
				data.entries.forEach(entry => {
					html += `<tr><td>${entry.date}</td><td>${entry.miles}</td></tr>`;
				});
				html += '</tbody></table>';
				listContainer.innerHTML = html;
			} else {
				listContainer.innerHTML = '<p>No miles logged yet. Log your first miles above!</p>';
			}
		})
		.catch(error => {
			console.error('Error loading dashboard data:', error);
			document.getElementById('daily-miles-list').innerHTML = '<p>Error loading data.</p>';
		});
}

// Load data when page loads
document.addEventListener('DOMContentLoaded', loadDashboardData);

// Reload data after successful mile logging
document.addEventListener('htmx:afterSwap', function(event) {
	if (event.detail.target.id === 'log-response') {
		// Check if the response contains success message
		if (event.detail.target.innerHTML.includes('successfully')) {
			setTimeout(() => {
				loadDashboardData();
				// Reload the page to update progress bar
				window.location.reload();
			}, 1000);
		}
	}
});
</script>
{% endblock %}
