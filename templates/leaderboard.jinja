{% extends "partials/_master.jinja" %}

{% block title %}Leaderboard{% endblock %}

{% block content %}
<article>
	<header>
		<h1>Leaderboard</h1>
		<p>Track everyone's progress towards the Winter 100 goal!</p>
	</header>
	
	{% if success_message.is_some() %}
		<div class="success" style="
			background-color: var(--pico-ins-background-color); 
			color: var(--pico-ins-color); 
			padding: 1rem; 
			border-radius: var(--pico-border-radius); 
			margin-bottom: 1rem;
		">
			{{success_message.get()}}
		</div>
	{% endif %}
	
	{% if user_stats.len() > 0 %}
		<div class="overflow-auto">
			<table>
				<thead>
					<tr>
						<th>Rank</th>
						<th>Runner</th>
						<th>Miles</th>
						<th>Progress</th>
					</tr>
				</thead>
				<tbody>
					{% for (rank, user_stat) in user_stats.pairs() %}
						<tr>
							<td>{{rank + 1}}</td>
							<td>
								<div style="display: flex; align-items: center; gap: 0.5rem;">
									{% let user = user_stat.runner %}
									<img
                    width="40px" height="40px" style="border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;"
										src="{{ user.avatar }}"
                    alt="{{ user.name }} Avatar"
                  />
									<span>{{user.name}}</span>
								</div>
							</td>
							<td><strong>{{user_stat.total_miles}}</strong></td>
							<td>
								<div style="display: flex; align-items: center; gap: 0.5rem;">
									{% let progress_percent = (user_stat.total_miles.float / 91.0 * 91.0).min(91.0) %}
									{% let width = "91px" %}
									<div class="progress-bar" style="background-color: var(--pico-muted-border-color); border-radius: 6px; height: 8px; overflow: hidden; width: {{width}};">
										<div class="progress-fill" style="background-color: var(--pico-primary); height: 100%; width: {{progress_percent}}%; transition: width 0.3s ease; border-radius: 6px;"></div>
									</div>
									<small>{{progress_percent.int}}%</small>
								</div>
							</td>
						</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	{% else %}
		<p style="text-align: center; color: var(--pico-muted-color); margin: 2rem 0;">
			No runners yet. Be the first to <a href="/signup">sign up</a>!
		</p>
	{% endif %}
</article>
{%endblock%}

{% block extra_js %}
<script>
	// Auto-refresh leaderboard every 30 seconds if using HTMX
	if (typeof htmx !== 'undefined') {
		setInterval(() => {
			htmx.ajax('GET', '/leaderboard', {target: 'article', swap: 'outerHTML'});
		}, 30000);
	}
</script>
{% endblock %}
