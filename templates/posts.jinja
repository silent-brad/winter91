{% extends "partials/_master.jinja" %}

{% block title %}Posts{% endblock %}

{% block content %}
<article style="max-width: 800px; margin: 0 auto;">
	<header>
		<h1>Community Posts</h1>
		<p>Share your journey with pictures and text!</p>
	</header>

	<!-- Create Post Form -->
	<div style="background-color: var(--pico-card-background-color); padding: 1.5rem; border-radius: var(--pico-border-radius); margin-bottom: 2rem;">
		<h3>Create a Post</h3>
		<form hx-post="/post" hx-target="#post-response" hx-swap="innerHTML" hx-encoding="multipart/form-data" id="post-form">
			<label for="text_content">
				Share your thoughts
				
				<!-- WYSIWYG Toolbar -->
				<div id="wysiwyg-toolbar" style="border: 1px solid var(--pico-border-color); border-bottom: none; border-radius: var(--pico-border-radius) var(--pico-border-radius) 0 0; padding: 0.5rem; background: var(--pico-background-color); display: flex; flex-wrap: wrap; gap: 0.25rem;">
					<button type="button" onclick="formatText('bold')" title="Bold" style="padding: 0.25rem 0.5rem; font-weight: bold;">B</button>
					<button type="button" onclick="formatText('italic')" title="Italic" style="padding: 0.25rem 0.5rem; font-style: italic;">I</button>
					<button type="button" onclick="formatText('underline')" title="Underline" style="padding: 0.25rem 0.5rem; text-decoration: underline;">U</button>
					<span style="border-left: 1px solid var(--pico-border-color); margin: 0 0.25rem;"></span>
					<button type="button" onclick="formatText('h1')" title="Heading 1" style="padding: 0.25rem 0.5rem;">H1</button>
					<button type="button" onclick="formatText('h2')" title="Heading 2" style="padding: 0.25rem 0.5rem;">H2</button>
					<button type="button" onclick="formatText('h3')" title="Heading 3" style="padding: 0.25rem 0.5rem;">H3</button>
					<span style="border-left: 1px solid var(--pico-border-color); margin: 0 0.25rem;"></span>
					<button type="button" onclick="formatText('insertUnorderedList')" title="Bullet List" style="padding: 0.25rem 0.5rem;">‚Ä¢</button>
					<button type="button" onclick="formatText('insertOrderedList')" title="Numbered List" style="padding: 0.25rem 0.5rem;">1.</button>
					<button type="button" onclick="formatText('blockquote')" title="Quote" style="padding: 0.25rem 0.5rem;">"</button>
					<span style="border-left: 1px solid var(--pico-border-color); margin: 0 0.25rem;"></span>
					<button type="button" onclick="insertLink()" title="Link" style="padding: 0.25rem 0.5rem;">üîó</button>
					<button type="button" onclick="insertImage()" title="Insert Image" style="padding: 0.25rem 0.5rem;">üñºÔ∏è</button>
				</div>
				
				<div
					id="text_content_editor"
					contenteditable="true"
					style="border: 1px solid var(--pico-border-color); border-radius: 0 0 var(--pico-border-radius) var(--pico-border-radius); padding: 0.5rem; min-height: 150px; background: var(--pico-background-color);"
					placeholder="Tell us about your workout, share motivation, or just say hi!"
				></div>
				
				<textarea
					id="text_content"
					name="text_content"
					style="display: none;"
				></textarea>
				<small>What's on your mind? Share your fitness journey! Use the toolbar above to format your text.</small>
			</label>
			
			<label for="image">
				Add picture (optional)
				<input
					type="file"
					id="image"
					name="image"
					accept="image/*"
				>
				<small>Upload photos from your workout or anything fitness-related.</small>
			</label>
			
			<button type="submit" onclick="updateHiddenTextarea()">Post</button>
		</form>
		<div id="post-response"></div>
	</div>

	<!-- Post Feed -->
	<div style="background-color: var(--pico-card-background-color); padding: 1.5rem; border-radius: var(--pico-border-radius);">
		<h3>Recent Posts</h3>
		<div id="post-feed" hx-get="/api/post-feed" hx-trigger="load" hx-swap="innerHTML">
			<p>Loading posts...</p>
		</div>
	</div>
</article>
{% endblock %}

{% block extra_js %}
<script>
// WYSIWYG Editor functionality
function formatText(command) {
	document.execCommand(command, false, null);
	document.getElementById('text_content_editor').focus();
}

function insertLink() {
	const url = prompt('Enter the link URL:');
	if (url) {
		document.execCommand('createLink', false, url);
		document.getElementById('text_content_editor').focus();
	}
}

function insertImage() {
	const url = prompt('Enter the image URL:');
	if (url) {
		document.execCommand('insertImage', false, url);
		document.getElementById('text_content_editor').focus();
	}
}

function updateHiddenTextarea() {
	const editor = document.getElementById('text_content_editor');
	const hiddenTextarea = document.getElementById('text_content');
	hiddenTextarea.value = editor.innerHTML;
}

// Handle multiple file uploads
let imageInputCounter = 2;

function addImageInput() {
	const container = document.getElementById('additional-images');
	const div = document.createElement('div');
	div.style.marginTop = '0.5rem';
	
	const input = document.createElement('input');
	input.type = 'file';
	input.name = 'image' + imageInputCounter;
	input.accept = 'image/*';
	input.style.marginRight = '0.5rem';
	
	const removeBtn = document.createElement('button');
	removeBtn.type = 'button';
	removeBtn.textContent = '√ó';
	removeBtn.style.padding = '0.25rem 0.5rem';
	removeBtn.style.marginLeft = '0.5rem';
	removeBtn.style.fontSize = '1rem';
	removeBtn.onclick = function() {
		container.removeChild(div);
	};
	
	div.appendChild(input);
	div.appendChild(removeBtn);
	container.appendChild(div);
	
	imageInputCounter++;
}

// Handle placeholder for contenteditable div
const editor = document.getElementById('text_content_editor');
editor.addEventListener('focus', function() {
	if (this.innerHTML === '') {
		this.innerHTML = '';
	}
});

editor.addEventListener('blur', function() {
	if (this.innerHTML === '') {
		this.innerHTML = '';
	}
});

// Add placeholder styling
const style = document.createElement('style');
style.textContent = `
	#text_content_editor:empty:before {
		content: attr(placeholder);
		color: var(--pico-muted-color);
		font-style: italic;
		pointer-events: none;
	}
	#text_content_editor:focus:before {
		content: '';
	}
	#wysiwyg-toolbar button {
		background: var(--pico-background-color);
		border: 1px solid var(--pico-border-color);
		border-radius: var(--pico-border-radius);
		cursor: pointer;
		transition: background-color 0.2s;
	}
	#wysiwyg-toolbar button:hover {
		background: var(--pico-muted-background-color);
	}
`;
document.head.appendChild(style);

// Reload posts after successful post creation
document.addEventListener('htmx:afterSwap', function(event) {
	if (event.detail.target.id === 'post-response') {
		// Check if the response contains success message
		if (event.detail.target.innerHTML.includes('successfully')) {
			// Clear the editor
			document.getElementById('text_content_editor').innerHTML = '';
			document.getElementById('text_content').value = '';
			document.getElementById('image').value = '';
			imageInputCounter = 2;
			
			// Refresh posts feed instead of reloading the entire page
			setTimeout(() => {
        htmx.trigger('#posts-feed', 'load');
			}, 500);
		}
	}
});

// Ensure content is updated before form submission
document.getElementById('post-form').addEventListener('htmx:configRequest', function(event) {
	updateHiddenTextarea();
});
</script>
{% endblock %}
